<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Receipts</title>
    <base target="_top">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">


    <style>
      @keyframes flash {
          0% {background-color: #e5f4ff;}  /* A very light blue */
          100% {background-color: transparent;}
      }

      .flash-bg {
          animation-name: flash;
          animation-duration: 1s;
      }

      #logList a.collapsed {
          text-decoration: none;
          color: inherit;  /* Keeps the text color consistent */
          cursor: default; /* This will remove the pointer hand, making it seem less like a typical hyperlink */
      }

      #logList a.collapsed:hover,
      #logList a.collapsed:focus,
      #logList a.collapsed:active,
      #logList a.collapsed:visited {
          text-decoration: none; 
          color: inherit;
      }

      .timestamp-container {
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .expand-badge {
          top: 0; /* Reset the top value */
          margin: 0; /* Reset margin */
          border: 1px solid #ddd; 
          color: #888; 
          cursor: pointer; 
      }

      .expand-badge:hover {
          background-color: #f7f7f7;
          color: #666;
      }

      .timestamp {
          font-size: 0.7rem; /* Adjust to your preference for a smaller font size */
      }

      .expansion-indicator {
          margin-left: 5px; /* Add some space between the message and the indicator */
      }
      

    </style>
</head>
<body class="bg-light py-5">

  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
    <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Error</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
            <!-- Error message will be populated here -->
        </div>
    </div>
</div>

  <div class="container">
      <div class="row justify-content-center">
          <div class="col-md-8">
              <div class="text-center mb-3">
                  <button id="receiptBtn" class="btn btn-outline-primary btn-lg">Find Receipts</button>
              </div>
              <div class="text-center mb-5">
                <!-- Spinner -->
                <div id="loadingSpinner" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                
                <!-- Status Icon -->
                <i id="statusIcon" class="bi" style="font-size: 2rem;"></i>
              </div>
              <div class="card">
                  <div class="card-header text-primary">
                      Messages
                  </div>
                  <ul id="logList" class="list-group list-group-flush">
                      <!-- Logs will be appended here -->
                  </ul>
              </div>
          </div>
      </div>
  </div>


<script>

  let defaultPollInterval = 1250 ;

  const handler = {
    get: function(target, prop) {

        console.log( "proxy get called for %s", prop ) ;

        // Check if the method is one of the specified ones
        if (["withFailureHandler", "withSuccessHandler", "withUserObject"].includes(prop)) {
            console.log( "passing through function call to new proxy") ;
            return function(...args) {
                // Pass the call to the base class but intercept the returned object
                return new Proxy(target[prop](...args), handler);
            }
        }

        return function(...args) {
            const processId = new Date().getTime().toString();
            
            const pollInterval = setInterval(() => {
                google.script.run
                    .withSuccessHandler(response => {
                        configInstance.debug(`client received: [${processId}] ${JSON.stringify(response)}`);
                        if (response.messages && response.messages.length > 0) {
                            response.messages.forEach(msg => msg && configInstance.log(msg));
                            // Schedule a one-time poll 
                            doOneTimePoll(75, processId);
                        }
                    })
                    .getProcessStatus(processId);
            }, 1250);

            // Success handler callback
            const onSuccess = () => {
                clearInterval(pollInterval);  // Stop the recurring polling
                configInstance.log("Function completed successfully.");
                // Perform a one-time poll 
                doOneTimePoll(10, processId);
            };

            const onError = (err) => {
              clearInterval(pollInterval);  // Stop the recurring polling

              // Display the error in the toast
              const errorMsg = err.message || 'An error occurred.';
              $('#errorToast .toast-body').text(
                  errorMsg.length > 120 ? errorMsg.substring(0, 120) + '...' : errorMsg
              );

              // Launch the toast
              let toast = new bootstrap.Toast($('#errorToast')[0]);
              toast.show();

              // Perform a one-time poll 150ms later
              doOneTimePoll(10, processId);
          };


          target
              .withSuccessHandler(onSuccess)
              .withFailureHandler(onError)
              .invokeWithId(prop, processId, ...args);
        }
    }
  };
  /**
   * Creates a log server that sets up a proxy for Google Apps Script server-side functions.
   * 
   * @param {Function} [log=console.log] - Logging function.
   * @param {Function} [debug=console.log] - Debug function.
   * @param {Function} [error=console.log] - Error function.
   * @param {Object} [target=google.script.run] - Target for server-side invocation.
   * @param {number} [pollInterval=1250] - Polling interval (default: 1750ms).
   * 
   * @throws {Error} If log, debug, or error is null.
   * @throws {Error} If pollInterval is not greater than zero.
   * 
   * @returns {Proxy} A new Proxy instance for server-side function invocation.
   */
  const createLogServer = (
      log = console.log, 
      debug = console.log, 
      error = console.log, 
      target = google.script.run,
      pollInterval = 1250
  ) => {

      // Argument validations
      if (!log || !debug || !error) {
          throw new Error('Log, debug, and error functions cannot be null.');
      }

      if (pollInterval <= 0) {
          throw new Error('Polling interval must be greater than zero.');
      }

      class Config {
          constructor(log, debug, error) {
              this.log = log;
              this.debug = debug;
              this.error = error;
          }
      }

      const configInstance = new Config(log, debug, error);

      const doOneTimePoll = (interval, processId) => {
          setTimeout(() => {
              google.script.run
                  .withSuccessHandler(response => {
                      configInstance.debug(`client received: [${processId}] ${JSON.stringify(response)}`);
                      if (response.messages && response.messages.length > 0) {
                          response.messages.forEach(msg => msg && configInstance.log(msg));
                      }
                  })
                  .getProcessStatus(processId);
          }, interval);
      };

      return new Proxy(target, handler);
  }

  $(document).ready(function() {

      let logCounter = 0;

      function addLog(message) {
          logCounter++;  // Increment the counter for every new log

          const timestamp = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', second: 'numeric' });
          let logContent;

          if (message.length > 120) {
              logContent = `
              <div class="timestamp-container" data-bs-toggle="collapse" href="#collapseContent${logCounter}" role="button">
                  <span class="text-muted timestamp">${timestamp}</span>
                  <span class="badge bg-light text-muted expand-badge">+</span>
                  <a class="collapsed d-block position-relative">
                      ${message.substring(0, 120)}... 
                  </a>
              </div>

              <div class="collapse mt-2" id="collapseContent${logCounter}">
                  ${message}
              </div>`;
          } else {
              logContent = `<span class="text-muted timestamp">${timestamp}</span> <br> ${message}`;
          }

          const logItem = `
          <li class="list-group-item flash-bg">
              ${logContent}
          </li>`;
          $('#logList').prepend(logItem);
          trimLogs();
      }

      $('#logList').on('show.bs.collapse', 'div.collapse', function() {
          $(this).prev('.timestamp-container').find('.expand-badge').text('-');
      }).on('hide.bs.collapse', 'div.collapse', function() {
          $(this).prev('.timestamp-container').find('.expand-badge').text('+');
      });


      function trimLogs() {
          while ($('#logList').children().length > 3000) {
              $('#logList').children().last().remove();
          }
      }

      function showStatusIndicator(message) {
        $("#statusIndicator")
          .removeClass("d-none alert-success alert-danger")
          .addClass("alert-primary")
          .find("#statusMessage")
          .text(message);
        
        $("#statusIcon").attr("class", "bi bi-hourglass");
      }

      function updateStatus(success, message) {
        if(success) {
          $("#statusIndicator").removeClass("alert-primary").addClass("alert-success");
          $("#statusIcon").attr("class", "bi bi-check-circle-fill");
        } else {
          $("#statusIndicator").removeClass("alert-primary").addClass("alert-danger");
          $("#statusIcon").attr("class", "bi bi-x-circle-fill");
        }
        $("#statusMessage").text(" " + message);
      }

      function clearStatus() {
        $("#statusIndicator").addClass("d-none").find("#statusMessage").text("");
        $("#statusIcon").attr("class", "bi");
      }


      $("#receiptBtn").on("click", function() {
        // Reset status indicator
        $('#statusIcon').removeClass().addClass('bi'); // Chain jQuery methods for brevity

        // Show the spinner when the button is clicked
        $('#loadingSpinner').show();

        console.log("button clicked");

        const server = createLogServer((mesg) => {
            Array.isArray(mesg) ? mesg.forEach((mesg) => addLog(mesg)) : addLog(mesg);
        });

        server
            .withSuccessHandler( (data) => {
                console.log("process emails finished");
                
                // Hide the spinner once the function completes successfully
                $('#loadingSpinner').hide();

                // Show the success status indicator
                $('#statusIcon').attr('class', 'bi bi-check-circle-fill text-success');
            })
            .withFailureHandler((error) => {
                // Hide the spinner once an error occurs
                $('#loadingSpinner').hide();

                // Show the failure status indicator
                $('#statusIcon').attr('class', 'bi bi-x-circle-fill text-danger');

            })
            .processMatchingEmails();
        });
    });
</script>
</body>

</html>
